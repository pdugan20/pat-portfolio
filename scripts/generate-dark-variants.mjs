import fs from 'fs';
import path from 'path';

function findImageFiles(dir, baseDir = '') {
  const files = [];
  const items = fs.readdirSync(dir);

  for (const item of items) {
    const fullPath = path.join(dir, item);
    const relativePath = path.join(baseDir, item);

    if (fs.statSync(fullPath).isDirectory()) {
      files.push(...findImageFiles(fullPath, relativePath));
    } else if (/\.(jpg|jpeg|png|webp|mp4|webm)$/i.test(item)) {
      files.push('/' + relativePath.replace(/\\/g, '/'));
    }
  }

  return files;
}

function generateDarkVariantsManifest() {
  const publicDir = path.join(process.cwd(), 'public');
  const assetsDir = path.join(publicDir, 'assets');

  if (!fs.existsSync(assetsDir)) {
    console.log('No assets directory found');
    return;
  }

  const allFiles = findImageFiles(assetsDir, 'assets');
  const manifest = {};

  for (const file of allFiles) {
    if (file.includes('-dark.')) {
      const lightFile = file.replace('-dark.', '.');
      if (allFiles.includes(lightFile)) {
        manifest[lightFile] = file;
      }
    }
  }

  // Generate TypeScript module with single-quote formatting
  const entries = Object.entries(manifest)
    .map(([light, dark]) => `  '${light}':\n    '${dark}'`)
    .join(',\n');

  const tsContent = `// Auto-generated by scripts/generate-dark-variants.mjs
// Maps light asset paths to their dark variant paths

export const darkVariants: Record<string, string> = {
${entries},
};
`;

  const tsPath = path.join(process.cwd(), 'lib', 'dark-variants.ts');
  fs.writeFileSync(tsPath, tsContent);

  console.log(
    `Generated dark variants module with ${Object.keys(manifest).length} entries:`
  );
  Object.entries(manifest).forEach(([light, dark]) => {
    console.log(`  ${light} -> ${dark}`);
  });
}

generateDarkVariantsManifest();
